###############################################################################
# curl command tests for templeton
#
#

#use Yahoo::Miners::Test::PigSetup;

#PigSetup::setup();

#my $me = `whoami`;
#chomp $me;

$cfg = 
{
 'driver' => 'Curl',

 'groups' => 
 [

##=============================================================================================================
  {
   'name' => 'DB_OPS',
   'tests' => 
   [
    {
     #check if db created by UNAME_OTHER is visible for user UNAME
     'num' => 1,

     'setup' => [
                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_a',
                  'user_name' => ':UNAME_OTHER:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{"comment":"Hello there", "properties":{"a":"b"}}'],
                 }
                ],
     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/',
     'user_name' => ':UNAME:',

     'format_header' => 'Content-Type: application/json',
     'json_field_substr_match' => {'databases' => 'hcatperms_a'},

     'status_code' => 200,
    },


    {

     #check if group id is set as per spec
     'num' => 2,
     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_b',
                  'user_name' => ':UNAME:',
                 },
                 {
                  'method' => 'PUT',
                  'post_options' => [
                               '{"permissions" : "rwxrwxrwx", 
                                  "group" : ":UGROUP:"
                                }'
                                            ],
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_b',
                  'user_name' => ':UNAME:',
                 },

                ],


     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_b',
     'user_name' => ':UNAME:',
     'format_header' => 'Content-Type: application/json',
     'json_field_substr_match' => {'location_perms' => 'rwxrwxrwx', 'location_group' => ':UGROUP:'},
     'status_code' => 200,
    },
    {

     #check if group id is set as per spec
     'num' => 3,
     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_c',
                  'user_name' => ':UNAME:',
                 },
                 {
                  'method' => 'PUT',
                  'post_options' => [
                               '{"permissions" : "rwxr-x---", 
                                  "group" : ":UGROUP:"
                                }'
                                    ],
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_c',
                  'user_name' => ':UNAME:',
                 },

                ],


     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_c',
     'user_name' => ':UNAME:',
     'format_header' => 'Content-Type: application/json',
     'json_field_substr_match' => {'location_perms' => 'rwxr-x---', 'location_group' => ':UGROUP:'},
     'status_code' => 200,
    },

    {

     #check if user belonging to same group is able to access
     'num' => 4,

     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_d',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'post_options' => [
                                     '{
                                     "permissions" : "r-xr-x---", 
                                     "group" : ":UGROUP:"
                                      }'
                                    ],
               
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_d',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                 }
                ],



     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_d',
     'user_name' => ':UNAME_GROUP:',
     'format_header' => 'Content-Type: application/json',
     'json_field_substr_match' => {'location_perms' => 'r-xr-x---', 'location_group' => ':UGROUP:'},
     'status_code' => 200,
    },

    {

     #check default db permissions and group
     'num' => 5,

     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_e',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_e',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{}']

                 }
                ],



     'method' => 'GET',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_e',
     'user_name' => ':UNAME_GROUP:',
     'format_header' => 'Content-Type: application/json',
     'json_field_substr_match' => {'location_perms' => 'rwx------', 'location_group' => ':UGROUP:'},
     'status_code' => 200,
    },

    {

     #check if user can delete table 
     'num' => 6,

     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_f',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_f',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{}']

                 }
                ],



     'method' => 'DELETE',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_f',
     'user_name' => ':UNAME:',
     'format_header' => 'Content-Type: application/json',
     'status_code' => 200,
    },

    {

     #check if user belonging to group can delete table 
     'num' => 7,

     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{ "permissions" : "rwxrwx---" }']

                 }
                ],



     'method' => 'DELETE',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
     'user_name' => ':UNAME_GROUP:',
     'format_header' => 'Content-Type: application/json',
     'status_code' => 200,
    },
    {

     #check if user belonging to group is unable to delete table  
     'num' => 8,
     'ignore' => 'see HCATALOG-401',
     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{ "permissions" : "rwx------" }']

                 }
                ],


     'method' => 'DELETE',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
     'user_name' => ':UNAME_GROUP:',
     'format_header' => 'Content-Type: application/json',
     'status_code' => 500,
    },

    {

     #check if user belonging to 'other' is unable to delete table  
     #See HCATALOG-401, this test will work only because/if the base 
     # warehouse dir does not have permissions for other. It makes sense
     # to add all users to a group that has permissions for wh dir, and
     #have no permissions for other
     'num' => 10,
     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{ "permissions" : "rwx------" }']

                 }
                ],


     'method' => 'DELETE',
     'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
     'user_name' => ':UNAME_OTHER:',
     'format_header' => 'Content-Type: application/json',
     'status_code' => 500,
    },


    {

     #check if user is able to create table
     'num' => 11,
     'setup' => [
                 {
                  'method' => 'DELETE',
                  'format_header' => 'Content-Type: application/json',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:?ifExists=true&option=cascade',
                  'user_name' => ':UNAME:',
                  'status_code' => 200,
                 },

                 {
                  'method' => 'PUT',
                  'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:',
                  'user_name' => ':UNAME:',
                  'format_header' => 'Content-Type: application/json',
                  'post_options' => ['{ "permissions" : "rwx------" }']

                 },

                ],


      'method' => 'PUT',
      'url' => ':TEMPLETON_URL:/templeton/v1/ddl/database/hcatperms_:TNUM:/table/permstable_:TNUM:',
      'format_header' => 'Content-Type: application/json', 
      'post_options' => ['{
              "columns": [
                      { "name" : "i", "type" : "int" },
                      { "name" : "j", "type" : "bigint", "comment" : "some comment" }
              ], 
  	          "format" : {  "storedAs" : "rcfile"} 
          }'],
      'user_name' => ':UNAME:',
      'status_code' => 200,

    },








   ]
  },

##=============================================================================================================





 ]
},
  ;

